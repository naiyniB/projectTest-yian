name: è§£å‹

on:
  push:
    branches:
      - main
    paths:
      - 'public/**'  # åªæœ‰å½“ public ç›®å½•å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘

jobs:
  cleanup-and-extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List current root contents
        run: |
          echo "Root contents before:"
          ls -la

      - name: Remove all root contents except .github and public
        run: |
          # ç§»é™¤æ ¹ç›®å½•ä¸­é™¤ .github å’Œ public å¤–çš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•
          find . -maxdepth 1 -not -name '.' -not -name '.github' -not -name 'public' -exec rm -rf {} +

      - name: List public contents
        run: |
          echo "Contents in public/:"
          ls -la public/

      - name: Find and extract zip files from public to root
        run: |
          # æŸ¥æ‰¾ public ç›®å½•ä¸‹çš„æ‰€æœ‰ .zip æ–‡ä»¶å¹¶è§£å‹åˆ°æ ¹ç›®å½•
          for zip_file in public/*.zip; do
            if [ -f "$zip_file" ]; then
              echo "Extracting $zip_file to root..."
              unzip "$zip_file" -d .
            fi
          done

      - name: Optional: Support other archive types (tar, gz, etc.)
        run: |
          # ç¤ºä¾‹ï¼šæ”¯æŒ .tar.gz
          for tar_file in public/*.tar.gz; do
            if [ -f "$tar_file" ]; then
              echo "Extracting $tar_file to root..."
              tar -xzf "$tar_file" -C .
            fi
          done

      - name: Clear contents of public (keep the directory)
        run: |
          echo "Removing files inside public/..."
          find public -mindepth 1 -delete

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ§¹ Clean up and extract from public"
            git push origin main
          fi
