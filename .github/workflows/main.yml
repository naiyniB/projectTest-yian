name: 解压

on:
  push:
    branches:
      - main
    paths:
      - 'public/**'  # 只有当 public 目录发生变化时才触发

jobs:
  cleanup-and-extract:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List current root contents
        run: |
          echo "Root contents before:"
          ls -la

      - name: Remove all root contents except .github and public
        run: |
          # 移除根目录中除 .github 和 public 外的所有文件和目录
          find . -maxdepth 1 -not -name '.' -not -name '.github' -not -name 'public' -exec rm -rf {} +

      - name: List public contents
        run: |
          echo "Contents in public/:"
          ls -la public/

      - name: Find and extract zip files from public to root
        run: |
          # 查找 public 目录下的所有 .zip 文件并解压到根目录
          for zip_file in public/*.zip; do
            if [ -f "$zip_file" ]; then
              echo "Extracting $zip_file to root..."
              unzip "$zip_file" -d .
            fi
          done

      - name: Optional: Support other archive types (tar, gz, etc.)
        run: |
          # 示例：支持 .tar.gz
          for tar_file in public/*.tar.gz; do
            if [ -f "$tar_file" ]; then
              echo "Extracting $tar_file to root..."
              tar -xzf "$tar_file" -C .
            fi
          done

      - name: Clear contents of public (keep the directory)
        run: |
          echo "Removing files inside public/..."
          find public -mindepth 1 -delete

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "🧹 Clean up and extract from public"
            git push origin main
          fi
